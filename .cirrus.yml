# Special .cirrus.yml file to test combination of AIO/DIO features.  WIP.

task:
  name: FreeBSD
  freebsd_instance:
    image_family: freebsd-12-1
  install_script:
    - uname -a
    - pkg install -y readline flex bison gmake perl5 p5-IPC-Run
  create_user_script:
    - pw useradd postgres
    - chown -R postgres:postgres .
  build_script:
    - su postgres -c './configure --enable-cassert --enable-debug --enable-tap-tests --with-posix-aio --with-includes=/usr/local/include --with-libs=/usr/local/lib'
    - su postgres -c 'make -s -j4'
  freebsd_worker_buf_script:
    - su postgres -c 'echo aio_type=worker > /tmp/extra.conf'
    - su postgres -c 'echo io_data_direct=off >> /tmp/extra.conf'
    - su postgres -c 'echo io_wal_direct=off >> /tmp/extra.conf'
    - su postgres -c 'TEMP_CONFIG=/tmp/extra.conf make -s check' || su postgres -c '( for F in ` find . -name initdb.log -o -name regression.diffs ` ; do echo === $F === ; head -1000 $F ; done ; exit 1 )'
  freebsd_worker_dio_script:
    - su postgres -c 'echo aio_type=worker > /tmp/extra.conf'
    - su postgres -c 'echo io_data_direct=on >> /tmp/extra.conf'
    - su postgres -c 'echo io_wal_direct=on >> /tmp/extra.conf'
    - su postgres -c 'TEMP_CONFIG=/tmp/extra.conf make -s check' || su postgres -c '( for F in ` find . -name initdb.log -o -name regression.diffs ` ; do echo === $F === ; head -1000 $F ; done ; exit 1 )'
  freebsd_posix_buf_script:
    - su postgres -c 'echo aio_type=posix > /tmp/extra.conf'
    - su postgres -c 'echo io_data_direct=off >> /tmp/extra.conf'
    - su postgres -c 'echo io_wal_direct=off >> /tmp/extra.conf'
    - su postgres -c 'TEMP_CONFIG=/tmp/extra.conf make -s check' || su postgres -c '( for F in ` find . -name initdb.log -o -name regression.diffs ` ; do echo === $F === ; head -1000 $F ; done ; exit 1 )'
  freebsd_posix_dio_script:
    - su postgres -c 'echo aio_type=posix > /tmp/extra.conf'
    - su postgres -c 'echo io_data_direct=on >> /tmp/extra.conf'
    - su postgres -c 'echo io_wal_direct=on >> /tmp/extra.conf'
    - su postgres -c 'TEMP_CONFIG=/tmp/extra.conf make -s check' || su postgres -c '( for F in ` find . -name initdb.log -o -name regression.diffs ` ; do echo === $F === ; head -1000 $F ; done ; exit 1 )'

task:
  name: macOS
  osx_instance:
    image: catalina-base
  install_script:
    - uname -a
    - cpan -T IPC::Run
  build_script:
    - export PERL5LIB=~/perl5/lib/perl5
    - ./configure --enable-cassert --enable-debug --enable-tap-tests --with-posix-aio --without-readline
    - make -s -j4
  macos_worker_buf_script:
    - export PERL5LIB=~/perl5/lib/perl5
    - echo aio_type=worker > /tmp/extra.conf
    - echo io_data_direct=off >> /tmp/extra.conf
    - echo io_wal_direct=off >> /tmp/extra.conf
    - TEMP_CONFIG=/tmp/extra.conf make -s check || ( for F in ` find . -name initdb.log -o -name regression.diffs ` ; do echo === $F === ; head -1000 $F ; done ; exit 1 )
  macos_worker_dio_script:
    - export PERL5LIB=~/perl5/lib/perl5
    - echo aio_type=worker > /tmp/extra.conf
    - echo io_data_direct=on >> /tmp/extra.conf
    - echo io_wal_direct=on >> /tmp/extra.conf
    - TEMP_CONFIG=/tmp/extra.conf make -s check || ( for F in ` find . -name initdb.log -o -name regression.diffs ` ; do echo === $F === ; head -1000 $F ; done ; exit 1 )
  macos_posix_buf_script:
    - export PERL5LIB=~/perl5/lib/perl5
    - echo aio_type=posix > /tmp/extra.conf
    - echo io_data_direct=off >> /tmp/extra.conf
    - echo io_wal_direct=off >> /tmp/extra.conf
    - TEMP_CONFIG=/tmp/extra.conf make -s check || ( for F in ` find . -name initdb.log -o -name regression.diffs ` ; do echo === $F === ; head -1000 $F ; done ; exit 1 )
  macos_posix_dio_script:
    - export PERL5LIB=~/perl5/lib/perl5
    - echo aio_type=posix > /tmp/extra.conf
    - echo io_data_direct=on >> /tmp/extra.conf
    - echo io_wal_direct=on >> /tmp/extra.conf
    - TEMP_CONFIG=/tmp/extra.conf make -s check || ( for F in ` find . -name initdb.log -o -name regression.diffs ` ; do echo === $F === ; head -1000 $F ; done ; exit 1 )

task:
  name: Linux
  container:
    image: debian:latest
  install_script:
    - uname -a
    - apt-get --yes update
    - DEBIAN_FRONTEND=noninteractive apt-get --yes install gcc libreadline-dev flex bison make perl libipc-run-perl clang llvm-dev libperl-dev libpython-dev tcl-dev libldap2-dev libicu-dev docbook-xml docbook-xsl fop libxml2-utils xsltproc krb5-admin-server krb5-kdc krb5-user slapd ldap-utils libssl-dev pkg-config locales-all
  create_user_script:
    - useradd -m postgres
    - chown -R postgres:postgres .
  build_script:
    - su postgres -c './configure --enable-cassert --enable-debug --enable-tap-tests --with-tcl --with-python --with-perl --with-ldap --with-openssl --with-icu --with-llvm'
    - su postgres -c 'make -s -j4'
  linux_worker_buf_script:
    - echo aio_type=worker > /tmp/extra.conf
    - echo io_data_direct=off >> /tmp/extra.conf
    - echo io_wal_direct=off >> /tmp/extra.conf
    - su postgres -c 'TEMP_CONFIG=/tmp/extra.conf make -s check' || su postgres -c '( for F in ` find . -name initdb.log -o -name regression.diffs ` ; do echo === $F === ; head -1000 $F ; done ; exit 1 )'
  linux_worker_dio_script:
    - echo aio_type=worker > /tmp/extra.conf
    - echo io_data_direct=on >> /tmp/extra.conf
    - echo io_wal_direct=on >> /tmp/extra.conf
    - su postgres -c 'TEMP_CONFIG=/tmp/extra.conf make -s check' || su postgres -c '( for F in ` find . -name initdb.log -o -name regression.diffs ` ; do echo === $F === ; head -1000 $F ; done ; exit 1 )'

task:
  name: Windows
  windows_container:
    image: cirrusci/windowsservercore:cmake
  install_script:
    - choco install -y winflexbison activeperl diffutils
    - rename c:\ProgramData\chocolatey\bin\win_flex.exe flex.exe
    - rename c:\ProgramData\chocolatey\bin\win_bison.exe bison.exe
  build_script:
    - SET PATH=%PATH%;C:\Perl64\bin
    - '"C:\Program Files (x86)\Microsoft Visual Studio\2017\BuildTools\VC\Auxiliary\Build\vcvars64.bat"'
    - perl buildsetup.pl
    - msbuild pgsql.sln
  windows_worker_buf_script:
    - SET PATH=%PATH%;C:\Perl64\bin
    - cd src\tools\msvc && vcregress check
